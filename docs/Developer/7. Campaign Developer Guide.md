#Overview

Analytics 에서 캠페인이란 인하우스 캠페인을 의미합니다. 이는 앱 내에서 팝업이나 배너를 통해 사용자에게 이벤트(미션)를 노출하고, 사용자가 이벤트를 진행한 경우 보상을 지급할 수 있는 기능을 제공합니다.
Toast Analytics가 제공하는 인하우스 캠페인 기능은 캠페인 실행에 따른 이용자 증가, 매출 증가에 대한 성과 분석 지표를 자동으로 제공하며, 캠페인의 효율을 극대화하기 위하여 캠페인 목적에 맞는 대상자 타게팅을 쉽게 적용할 수 있습니다.

이 기능을 사용하기 위해서는 크게 아래와 같은 추가 작업이 필요하며 이 문서는 해당 작업들에 대한 자세한 설명을 담고 있습니다.
1.캠페인 노출 및 보상 처리를 위해 앱 클라이언트에 Toast Analytics SDK의 적용이 필요합니다.
2.사용자의 미션 달성 알림 및 보상 확인을 위해 게임 서버(혹은 애플리케이션 서버와 캠페인 서버간의 통신이 필요합니다.

##용어설명
캠페인 서비스에서는 다음 용어를 내부적으로 사용합니다.

|용어|설명|
|---|---|
|(인하우스) 캠페인|	앱 내에서 팝업이나 배너를 통해 사용자에게 이벤트(미션)을 노출하고, 사용자가 미션을 달성한 경우 보상을 지급할 수 있는 Toast Analytics의 기능을 의미한다|
|(캠페인) 미션|	캠페인의 보상 지급을 위해 사용자가 달성해야 하는 목표를 의미한다|
|커스텀 데이터|	커스텀 데이터|
|(캠페인) 보상|	사용자가 미션을 달성한 경우 지급해야 하는 앱 내의 재화를 의미한다|

##중요 연동 항목 설명
Campaign 서비스의 동작 흐름은 아래 그림과 같습니다.
![Project Sett](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics/master/docs/Developer/images/image003.png)
[그림 1 서비스 동작 흐름도]

아래는 연동 시 필요한 중요 항목에 대한 간단한 설명이며 이 문서 뒷 부분에서 좀 더 자세한 내용을 살펴볼 수 있습니다.
###1. TOAST Analytics SDK 적용
Analytics Campaign 기능을 사용하기 위해서는 Toast Analytics SDK를 앱에 적용해야 합니다.
적용과 관련된 내용은 이 문서 뒷 부분에서 확인할 수 있으며 별도로 제공되는 Toast Analytics API 레퍼런스 문서를 참조해도 됩니다.

###2. 캠페인 설정
신규 캠페인을 바로 생성할 수도 있지만 템플릿을 통해 효율적인 캠페인을 좀 더 빠르고 쉽게 만들 수 있습니다. 
Toast Analytics 사이트의 [캠페인 실행] 메뉴를 통하여 새로운 캠페인을 등록할 수 있습니다. 이에 대한 자세한 설명은 해당 페이지의 우측 상단에 위치한 [페이지 가이드]를 통하여 제공됩니다.

###3. 테스트 단말기 등록
캠페인이 일반 사용자에게 노출되기 전, 캠페인의 정상 노출 및 동작여부를 확인하기 위하여 테스트 과정을 거쳐야 하며, Toast Analytics SDK를 통해 Device ID와 Device Token을 획득한 후 테스트 단말기를 등록하면 됩니다.
Analytics 사이트 내 [앱 설정 버튼] > [캠페인 설정] > [테스트 디바이스 설정] 을 통해 테스트 단말기를 등록할 수 있습니다.

###4. 캠페인 테스트 진행
테스트 단말기가 정상적으로 등록되면, Toast Analytics 웹사이트 내의 [캠페인 실행 메뉴] > [캠페인 리스트] > [테스트 버튼]을 통해 테스트를 진행하실 수 있습니다.

###5. 캠페인 동작 확인
테스트 단말기를 통해 캠페인의 정상 동작 여부를 확인합니다. 아래와 같은 총 4단계의 진행 상태를 확인해야 하며 개별 단계에서의 자세한 사항은 Toast Analytics 사이트 우측 상단의 페이지 가이드에서에서 확인하시면 됩니다.
단, 미션 달성 & 보상 검증은 미션 및 보상을 설정한 캠페인의 경우에만 해당됩니다.
- 노출: 테스트 단말기로 캠페인 정보가 정상적으로 전달되어 노출준비가 된 상태를 의미합니다.
- 실행: 테스트 단말기에서 배너 혹은 팝업이 노출되어 캠페인에 참여되었음을 의미합니다.
- 미션: 게임 서버에서 캐Y인 서버로 미션 데이터가 정상적으로 전달되었음을 의미합니다.
- 보상: 캠페인 서버에서 게임 서버로 정보가 정상적으로 전달되었음을 의미합니다.

###6. 캠페인 노출
캠페인 테스트가 모두 완료된 경우 외부 사용자가 접근할 수 있도록 캠페인을 오픈할 수 있습니다. 캠페인이 오픈되고 앱이 캠페인 노출 지점(캠페인 설정 >노출위치 설정 참조)에 다다른 경우 캠페인이 노출됩니다.

###7. 미션 완료 및 보상 처리
캠페인의 미션을 달성하기 위해 사용자가 특정 행동(예. 레벨, 랭킹의 변화 등)을 하였다면 게임 서버는 캠페인 서버 API(check mission)를 호출하여 미션달성 여부를 확인할 수 있습니다. 
미션이 달성된 경우에는 캠페인 서버에서 게임서버로 보상정보가 전달되며 이 정보를 근거로 게임서버에서는 클라이언트로 보상을 지급해주어야 합니다.

#캠페인 적용

Campaign 시스템의 동작 흐름은 아래 그림2와 같습니다.
![Project Sett](https://raw.githubusercontent.com/ToastAnalytics/ToastAnalytics/master/docs/Developer/images/image004.png)

[그림 2 시스템 동작 흐름도]

##게임 클라이언트

개념 이해를 돕기 위해 Java Code로 설명합니다. 자세한 내용은 각 플랫폼 별로 제공되는 Programming Guide를 참고하세요.

##게임서버

###1. 게임서버 인증
캠페인 서버에 대한 접근 제한 정책이 ACL에서 다른 방식으로 변경될 예정입니다. 
현재는 외부 유입에 대하여 ACL을 통한 제한을 하고 있지 않은 상태입니다.
향후 인증 관련 정책이 결정되면 추가 작업이 필요할 수 있습니다.

###2. 보상처리
캠페인과 관련되어 게임서버의 주된 작업은 보상처리입니다.
게임서버는 다음의 경우에 대해 캠페인 Server로 check-mission API를 호출하여 미션달성 여부를 확인해야 합니다.
- 캠페인이 진행 중일 때, 미션설정과 관련된 Factor(Level, Ranking, 게임실행횟수 등 게임에서 지정한 값)의 변화가 있는 경우

캠페인 서버에 check-mission API를 호출했을 때 보상이 있는 경우에는 보상코드를 전달 받게 되며 게임클라이언트로 보상을 전달하면 됩니다. 이 처리는 게임에서 구현합니다. (응답 데이터의 rewardList 필드를 통해 보상 정보가 전달되며 한번만 전달됩니다. 주의할 점은 보상이 없는 경우에도 rewardList 필드는 전달되며 빈 값이 전달됩니다. 

게임서버가 호출해야 하는 미션 달성 알림 API의 포맷은 아래와 같습니다.

###3. 요청 예시
```json
Host: https://api-campaign-analytics.cloud.toast.com
POST /campaign/v1/server/check-mission
Content-Type: application/json
{
    "header":
    {
	    "transactionId" : 92348729384729,
    },
    "userId" : "23948234",
    "appId" : "13",
    "missionKey" : "LEVEL",
    "missionValue" : 10
} 
```

###4. 요청 파라미터
요청 파라미터

|이름|자료형|설명|
|---|---|---|
|transactionId|	int64|	요청에 대한 추적을 위해 로깅 시에 사용되며 필수 값은 아닙니다. 여기에 입력된 값은 응답 데이터의 transactionId 필드에 동일하게 설정되어 반환됩니다|
|userId|	string|	게임에서 제공하는 사용자 unique ID|
|appId|	string|앱 등록 시 할당받은 앱 번호. Analytics 사이트의 [앱설정] > [AppKey]값을 입력하시면됩니다.|
|missionKey|	string|	특정 행동을 정의하는 Key 값 혹은 onMissionComplete(SDK) 를 통해 전달받은 값, Analytics 사이트의 [앱설정] > [캠페인 설정]> [미션 및 보상 아이템 설정]에서 등록한 미션 key 값|
|missionValue|	int64|	missionKey 에 대한 Value 값|

###5. 응답 예시

```json
HTTP/1.1 200 OK
{
    "header" :
    {
        "transactionId" : 92348729384729,
        "isSuccessful" : "false",
        "resultcode" : 9001,
        "resultMessages" : ["Invalid input parameter.", "..."],
        "serviceCode" : 10
    },
    "rewardList" : [
    {
        "campaignId" : 7,
        "promoDateBegin" : "2014-10-10 00:00:00",
        "promoDateEnd" : "2014-10-11 00:00:00",
        "rewardDateBegin" : "2014-10-10 00:00:00",
        "rewardDateEnd" : "2014-10-12 00:00:00",
        "rewardCode" : "gem",
        "rewardValue" : 100
    },
    ...
    ]
}
```

###6. 응답 데이터
응답 데이터

|이름|자료형|설명|
|---|---|---|
|transactionId	|int64|	요청 시 전달받은 transactionId 를 동일하게 설정한다|
|isSuccessful	|string|	수행 성공 여부를 설정한다. (성공: "true", 실패: "false")|
|resultCode	|int|	리턴 코드를 작성한다. (성공인 경우 0)|
|resultMessages	|vector<string>|	복수 개의 리턴 메시지를 작성한다.|
|serviceCode	|int|	서비스 코드|
|campaignId	|int|	보상이 있는 캠페인 번호|
|promoDateBegin	|string|	캠페인 시작 시간 (UTC+0 기준)|
|promoDateEnd	|string|	캠페인 종료 시간 (UTC+0 기준)|
|rewardDateBegin	|string|	보상 시작 시간 (UTC+0 기준)|
|rewardDateEnd	|string|	보상 종료 시간 (UTC+0 기준)|
|rewardCode	|string|	보상 코드|
|rewardValue	|int|	보상 값|
